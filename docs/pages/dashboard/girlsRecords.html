<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Girls Match Entry - Strike Master</title>
  <link rel="icon" type="image/png" href="../../assets/images/StrikeMasterLogo2.png">
  <link rel="stylesheet" type="text/css" href="../../assets/css/style.css">
  <link rel="stylesheet" type="text/css" href="../../assets/css/stored-colors.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="../../assets/js/accent-loader.js"></script>
  <script src="../../assets/js/config/api.js"></script>
  <script src="../../assets/js/auth-helper.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
    }

    .container {
      max-width: 700px;
      margin: 30px auto;
      padding: 20px;
    }

    .page-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .page-header h1 {
      color: var(--accent-color);
      margin-bottom: 8px;
      font-size: 28px;
    }

    .page-header p {
      color: var(--text-color);
      opacity: 0.7;
      margin: 0;
    }

    /* Gender Toggle */
    .gender-toggle {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 25px;
    }

    .gender-btn {
      padding: 12px 36px;
      border: none;
      background: var(--card-bg);
      color: var(--text-color);
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      text-decoration: none;
    }

    .gender-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .gender-btn.active {
      background: var(--accent-color);
      color: white;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }

    /* Cards */
    .card {
      background: var(--card-bg);
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .card h2 {
      margin: 0 0 20px;
      color: var(--accent-color);
      font-size: 18px;
      font-weight: 600;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }

    .form-row.single {
      grid-template-columns: 1fr;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-weight: 500;
      margin-bottom: 6px;
      font-size: 14px;
      color: var(--text-color);
    }

    .form-group input, .form-group select {
      padding: 12px 14px;
      border: 1px solid rgba(0,0,0,0.15);
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
      background: var(--content-bg);
      color: var(--text-color);
      transition: border-color 0.2s;
    }

    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: var(--accent-color);
    }

    /* Scores Section */
    .scores-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }

    .scores-grid .header {
      font-weight: 600;
      font-size: 13px;
      text-align: center;
      padding: 8px;
      color: var(--text-color);
      opacity: 0.7;
    }

    .scores-grid .team-label {
      display: flex;
      align-items: center;
      font-weight: 600;
      font-size: 14px;
      padding: 8px 0;
    }

    .score-input {
      width: 100%;
      padding: 12px;
      border: 1px solid rgba(0,0,0,0.15);
      border-radius: 8px;
      text-align: center;
      font-size: 16px;
      font-weight: 600;
      font-family: inherit;
      background: var(--content-bg);
      color: var(--text-color);
    }

    .score-input:focus {
      outline: none;
      border-color: var(--accent-color);
    }

    .score-input.winner {
      background: rgba(34, 197, 94, 0.15);
      border-color: #22c55e;
    }

    .score-input.loser {
      background: rgba(239, 68, 68, 0.1);
      border-color: #ef4444;
    }

    /* Results Card */
    .results-card {
      background: linear-gradient(135deg, var(--accent-color) 0%, color-mix(in srgb, var(--accent-color) 80%, black) 100%);
      color: white;
      text-align: center;
    }

    .results-card h2 {
      color: white;
      opacity: 0.9;
    }

    .result-display {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 30px;
      margin-bottom: 16px;
    }

    .team-score {
      text-align: center;
    }

    .team-score .label {
      font-size: 14px;
      opacity: 0.85;
      margin-bottom: 4px;
    }

    .team-score .score {
      font-size: 48px;
      font-weight: 700;
    }

    .vs {
      font-size: 20px;
      font-weight: 600;
      opacity: 0.6;
    }

    .result-badge {
      display: inline-block;
      padding: 8px 24px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 16px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .result-badge.win {
      background: rgba(255,255,255,0.25);
    }

    .result-badge.loss {
      background: rgba(0,0,0,0.2);
    }

    .result-badge.tie {
      background: rgba(255,255,255,0.15);
    }

    .points-breakdown {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(255,255,255,0.2);
      font-size: 13px;
    }

    .points-breakdown span {
      opacity: 0.85;
    }

    /* Submit Button */
    .submit-btn {
      width: 100%;
      background: var(--accent-color);
      color: white;
      border: none;
      padding: 16px 30px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .submit-btn:hover {
      filter: brightness(0.95);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Message */
    .message {
      padding: 14px;
      margin-bottom: 20px;
      border-radius: 10px;
      text-align: center;
      font-weight: 500;
      display: none;
    }

    .message.success {
      background: #dcfce7;
      color: #166534;
      display: block;
    }

    .message.error {
      background: #fee2e2;
      color: #991b1b;
      display: block;
    }

    @media (max-width: 600px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      .scores-grid {
        grid-template-columns: 1fr 1fr 1fr 1fr;
        gap: 8px;
      }
      .result-display {
        gap: 16px;
      }
      .team-score .score {
        font-size: 36px;
      }
    }
  </style>
</head>
<body>
  <div class="navbar">
    <a href="../../index.html" class="logo">
      <img src="../../assets/images/Team Logos/phLogo.png" alt="Strike Master Logo">
    </a>
    <div class="nav-links">
      <a href="teamSelector.html">Home</a>
      <a href="boysRecords.html" style="color: var(--accent-color);">Records</a>
      <a href="boysPlayers.html">Players</a>
      <a href="../settings/appearanceSettings.html">Settings</a>
      <a href="myTeam.html">My Team</a>
      <a href="#" id="logoutBtn" style="color:#dc3545;">Logout</a>
    </div>
  </div>

  <div class="container">
    <div class="page-header">
      <h1>Log Match</h1>
      <p>Enter team scores to calculate points automatically</p>
    </div>

    <div class="gender-toggle">
      <a href="boysRecords.html" class="gender-btn">Boys</a>
      <a href="girlsRecords.html" class="gender-btn active">Girls</a>
    </div>

    <div id="message" class="message"></div>

    <!-- Match Info -->
    <div class="card">
      <h2>Match Details</h2>
      <div class="form-row">
        <div class="form-group">
          <label for="matchDate">Date</label>
          <input type="date" id="matchDate" required>
        </div>
        <div class="form-group">
          <label for="opponent">Opponent</label>
          <input type="text" id="opponent" placeholder="e.g., Pascack Valley" required>
        </div>
      </div>
      <div class="form-row single">
        <div class="form-group">
          <label for="location">Location (optional)</label>
          <input type="text" id="location" placeholder="e.g., Montvale Lanes">
        </div>
      </div>
    </div>

    <!-- Scores Entry -->
    <div class="card">
      <h2>Game Scores</h2>
      <div class="scores-grid">
        <div class="header"></div>
        <div class="header">Game 1</div>
        <div class="header">Game 2</div>
        <div class="header">Game 3</div>
        
        <div class="team-label">Your Team</div>
        <input type="number" class="score-input" id="yourG1" min="0" max="1500" placeholder="0" oninput="calculateResults()">
        <input type="number" class="score-input" id="yourG2" min="0" max="1500" placeholder="0" oninput="calculateResults()">
        <input type="number" class="score-input" id="yourG3" min="0" max="1500" placeholder="0" oninput="calculateResults()">
        
        <div class="team-label">Opponent</div>
        <input type="number" class="score-input" id="oppG1" min="0" max="1500" placeholder="0" oninput="calculateResults()">
        <input type="number" class="score-input" id="oppG2" min="0" max="1500" placeholder="0" oninput="calculateResults()">
        <input type="number" class="score-input" id="oppG3" min="0" max="1500" placeholder="0" oninput="calculateResults()">
      </div>
    </div>

    <!-- Auto-calculated Results -->
    <div class="card results-card" id="resultsCard" style="display: none;">
      <h2>Match Result</h2>
      <div class="result-display">
        <div class="team-score">
          <div class="label">Your Team</div>
          <div class="score" id="yourPoints">0</div>
        </div>
        <div class="vs">-</div>
        <div class="team-score">
          <div class="label">Opponent</div>
          <div class="score" id="oppPoints">0</div>
        </div>
      </div>
      <div class="result-badge" id="resultBadge">TIE</div>
      <div class="points-breakdown">
        <span>G1: <strong id="g1Winner">-</strong></span>
        <span>G2: <strong id="g2Winner">-</strong></span>
        <span>G3: <strong id="g3Winner">-</strong></span>
        <span>Total: <strong id="totalWinner">-</strong></span>
      </div>
    </div>

    <button class="submit-btn" id="submitBtn">Save Match</button>
  </div>

  <script>
    // Require authentication
    if (!auth.requireCoach('../auth/login.html')) {
      throw new Error('Not authenticated');
    }

    const currentUser = auth.getUser();
    const GENDER = 'girls';

    // Setup logout
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      if (confirm('Are you sure you want to logout?')) {
        auth.logout('../../index.html');
      }
    });

    // Calculate results automatically
    function calculateResults() {
      const yourG1 = parseInt(document.getElementById('yourG1').value) || 0;
      const yourG2 = parseInt(document.getElementById('yourG2').value) || 0;
      const yourG3 = parseInt(document.getElementById('yourG3').value) || 0;
      const oppG1 = parseInt(document.getElementById('oppG1').value) || 0;
      const oppG2 = parseInt(document.getElementById('oppG2').value) || 0;
      const oppG3 = parseInt(document.getElementById('oppG3').value) || 0;

      const yourTotal = yourG1 + yourG2 + yourG3;
      const oppTotal = oppG1 + oppG2 + oppG3;

      // Calculate points: 2 for each game win, 1 for total win
      let yourPoints = 0;
      let oppPoints = 0;

      // Game 1: 2 points
      if (yourG1 > oppG1) yourPoints += 2;
      else if (oppG1 > yourG1) oppPoints += 2;

      // Game 2: 2 points
      if (yourG2 > oppG2) yourPoints += 2;
      else if (oppG2 > yourG2) oppPoints += 2;

      // Game 3: 2 points
      if (yourG3 > oppG3) yourPoints += 2;
      else if (oppG3 > yourG3) oppPoints += 2;

      // Total: 1 point
      if (yourTotal > oppTotal) yourPoints += 1;
      else if (oppTotal > yourTotal) oppPoints += 1;

      // Show results card if any scores entered
      const hasScores = yourG1 || yourG2 || yourG3 || oppG1 || oppG2 || oppG3;
      document.getElementById('resultsCard').style.display = hasScores ? 'block' : 'none';

      if (hasScores) {
        document.getElementById('yourPoints').textContent = yourPoints;
        document.getElementById('oppPoints').textContent = oppPoints;

        // Update breakdown
        document.getElementById('g1Winner').textContent = yourG1 > oppG1 ? '+2' : (oppG1 > yourG1 ? '0' : '0');
        document.getElementById('g2Winner').textContent = yourG2 > oppG2 ? '+2' : (oppG2 > yourG2 ? '0' : '0');
        document.getElementById('g3Winner').textContent = yourG3 > oppG3 ? '+2' : (oppG3 > yourG3 ? '0' : '0');
        document.getElementById('totalWinner').textContent = yourTotal > oppTotal ? '+1' : (oppTotal > yourTotal ? '0' : '0');

        // Update result badge
        const badge = document.getElementById('resultBadge');
        if (yourPoints > oppPoints) {
          badge.textContent = 'WIN';
          badge.className = 'result-badge win';
        } else if (oppPoints > yourPoints) {
          badge.textContent = 'LOSS';
          badge.className = 'result-badge loss';
        } else {
          badge.textContent = 'TIE';
          badge.className = 'result-badge tie';
        }

        // Highlight winning scores
        highlightScores('yourG1', 'oppG1', yourG1, oppG1);
        highlightScores('yourG2', 'oppG2', yourG2, oppG2);
        highlightScores('yourG3', 'oppG3', yourG3, oppG3);
      }
    }

    function highlightScores(yourId, oppId, yourScore, oppScore) {
      const yourEl = document.getElementById(yourId);
      const oppEl = document.getElementById(oppId);
      
      yourEl.classList.remove('winner', 'loser');
      oppEl.classList.remove('winner', 'loser');
      
      if (yourScore > oppScore) {
        yourEl.classList.add('winner');
        oppEl.classList.add('loser');
      } else if (oppScore > yourScore) {
        yourEl.classList.add('loser');
        oppEl.classList.add('winner');
      }
    }

    // Save match
    async function saveMatch() {
      const matchDate = document.getElementById('matchDate').value;
      const opponent = document.getElementById('opponent').value.trim();
      const location = document.getElementById('location').value.trim();

      const yourG1 = parseInt(document.getElementById('yourG1').value) || 0;
      const yourG2 = parseInt(document.getElementById('yourG2').value) || 0;
      const yourG3 = parseInt(document.getElementById('yourG3').value) || 0;
      const oppG1 = parseInt(document.getElementById('oppG1').value) || 0;
      const oppG2 = parseInt(document.getElementById('oppG2').value) || 0;
      const oppG3 = parseInt(document.getElementById('oppG3').value) || 0;

      if (!matchDate || !opponent) {
        showMessage('Please fill in match date and opponent', 'error');
        return;
      }

      if (!yourG1 && !yourG2 && !yourG3) {
        showMessage('Please enter at least one game score', 'error');
        return;
      }

      const yourTotal = yourG1 + yourG2 + yourG3;
      const oppTotal = oppG1 + oppG2 + oppG3;

      // Calculate points
      let yourPoints = 0;
      let oppPoints = 0;
      if (yourG1 > oppG1) yourPoints += 2; else if (oppG1 > yourG1) oppPoints += 2;
      if (yourG2 > oppG2) yourPoints += 2; else if (oppG2 > yourG2) oppPoints += 2;
      if (yourG3 > oppG3) yourPoints += 2; else if (oppG3 > yourG3) oppPoints += 2;
      if (yourTotal > oppTotal) yourPoints += 1; else if (oppTotal > yourTotal) oppPoints += 1;

      const result = yourPoints > oppPoints ? 'win' : (oppPoints > yourPoints ? 'loss' : 'tie');

      try {
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('submitBtn').textContent = 'Saving...';

        const matchRes = await api.post('/api/matches', {
          coachId: currentUser.id,
          gender: GENDER,
          opponent,
          matchDate,
          location: location || null,
          yourGame1: yourG1,
          yourGame2: yourG2,
          yourGame3: yourG3,
          yourTotal,
          oppGame1: oppG1,
          oppGame2: oppG2,
          oppGame3: oppG3,
          oppTotal,
          yourPoints,
          oppPoints,
          result
        });

        if (!matchRes.ok) {
          const err = await matchRes.json();
          showMessage(err.error || 'Failed to save match', 'error');
          document.getElementById('submitBtn').disabled = false;
          document.getElementById('submitBtn').textContent = 'Save Match';
          return;
        }

        showMessage('Match saved successfully!', 'success');
        
        // Clear form after 2 seconds
        setTimeout(() => {
          document.getElementById('matchDate').value = '';
          document.getElementById('opponent').value = '';
          document.getElementById('location').value = '';
          document.getElementById('yourG1').value = '';
          document.getElementById('yourG2').value = '';
          document.getElementById('yourG3').value = '';
          document.getElementById('oppG1').value = '';
          document.getElementById('oppG2').value = '';
          document.getElementById('oppG3').value = '';
          document.getElementById('resultsCard').style.display = 'none';
          document.getElementById('message').className = 'message';
          document.getElementById('submitBtn').disabled = false;
          document.getElementById('submitBtn').textContent = 'Save Match';
          
          // Clear highlights
          document.querySelectorAll('.score-input').forEach(el => {
            el.classList.remove('winner', 'loser');
          });
        }, 2000);

      } catch (err) {
        console.error('Failed to save match:', err);
        showMessage('Failed to save match. Please try again.', 'error');
        document.getElementById('submitBtn').disabled = false;
        document.getElementById('submitBtn').textContent = 'Save Match';
      }
    }

    function showMessage(text, type) {
      const msg = document.getElementById('message');
      msg.textContent = text;
      msg.className = `message ${type}`;
      setTimeout(() => { msg.className = 'message'; }, 5000);
    }

    document.getElementById('submitBtn').addEventListener('click', saveMatch);
  </script>
</body>
</html>
