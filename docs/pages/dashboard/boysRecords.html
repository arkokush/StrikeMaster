<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Boys Match Records - Strike Master</title>
  <link rel="stylesheet" type="text/css" href="../../assets/css/style.css">
  <link rel="stylesheet" type="text/css" href="../../assets/css/stored-colors.css">
  <script src="../../assets/js/accent-loader.js"></script>
  <script src="../../assets/js/config/api.js"></script>
  <script src="../../assets/js/auth-helper.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
    }

    .container {
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
    }

    .page-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .page-header h1 {
      color: var(--accent-color);
      margin-bottom: 10px;
    }

    .match-form {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 10px;
      border: 2px solid var(--accent-color);
      margin-bottom: 30px;
    }

    .match-form h2 {
      margin-top: 0;
      color: var(--accent-color);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-weight: 600;
      margin-bottom: 5px;
    }

    .form-group input, .form-group select {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
    }

    .players-table {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 10px;
      border: 2px solid var(--accent-color);
      margin-bottom: 20px;
    }

    .players-table h3 {
      margin-top: 0;
      color: var(--accent-color);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: var(--accent-color);
      color: white;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      font-weight: 600;
    }

    .score-input {
      width: 70px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      text-align: center;
    }

    .varsity-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .comments-section {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 10px;
      border: 2px solid var(--accent-color);
      margin-bottom: 20px;
    }

    .comments-section h3 {
      margin-top: 0;
      color: var(--accent-color);
    }

    .comments-section textarea {
      width: 100%;
      min-height: 100px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-family: Arial, sans-serif;
      font-size: 14px;
      resize: vertical;
      box-sizing: border-box;
    }

    .submit-btn {
      background: var(--accent-color);
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
    }

    .submit-btn:hover {
      opacity: 0.9;
    }

    .message {
      padding: 12px;
      margin-bottom: 20px;
      border-radius: 5px;
      text-align: center;
      font-weight: 600;
      display: none;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      display: block;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      display: block;
    }

    .split-button {
      display: flex;
      width: 300px;
      height: 40px;
      border-radius: 20px;
      overflow: hidden;
      border: 2px solid #fff;
      margin-left: 40px;
    }

    .split-button a {
      flex: 1;
      text-decoration: none;
      color: var(--main-color);
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease;
    }

    .girls { background-color: #b2b2b2; }
    .girls:hover { background-color: #929292; }
    .boys { background-color: #b2b2b2; }
    .boys:hover { background-color: #929292; }
    .split-button a.active { filter: brightness(75%); }

    .no-players {
      text-align: center;
      padding: 40px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="navbar">
    <a href="../../index.html" class="logo">
      <img src="../../assets/images/images/phLogo.png" alt="Strike Master Logo">
    </a>

    <div class="split-button">
      <a href="boysRecords.html" class="boys active">Boys</a>
      <a href="girlsRecords.html" class="girls">Girls</a>
    </div>

    <div class="nav-links">
      <a href="teamSelector.html">Home</a>
      <a href="boysRecords.html">Records</a>
      <a href="boysPlayers.html">Players</a>
      <a href="../settings/appearanceSettings.html">Settings</a>
      <a href="myTeam.html">My Team</a>
      <a href="#" id="logoutBtn" style="color:#dc3545;">Logout</a>
    </div>
  </div>

  <div class="container">
    <div class="page-header">
      <h1>Boys Team Match Entry</h1>
      <p>Record scores for a bowling match</p>
    </div>

    <div id="message" class="message"></div>

    <div class="match-form">
      <h2>Match Information</h2>
      <div class="form-row">
        <div class="form-group">
          <label for="matchDate">Match Date *</label>
          <input type="date" id="matchDate" required>
        </div>
        <div class="form-group">
          <label for="opponent">Opponent *</label>
          <input type="text" id="opponent" placeholder="e.g., Pascack Valley" required>
        </div>
        <div class="form-group">
          <label for="location">Location</label>
          <input type="text" id="location" placeholder="e.g., Montvale Lanes">
        </div>
      </div>
    </div>

    <div class="players-table">
      <h3>Player Scores</h3>
      <div id="playersContainer">
        <p class="no-players">Loading players...</p>
      </div>
    </div>

    <div class="comments-section">
      <h3>Match Notes</h3>
      <textarea id="comments" placeholder="Add any notes about the match (optional)..."></textarea>
    </div>

    <button class="submit-btn" id="submitBtn">Save Match & Scores</button>
  </div>

  <script>
    // Require authentication
    if (!auth.requireCoach('../auth/teacherLogin.html')) {
      throw new Error('Not authenticated');
    }

    const currentUser = auth.getUser();
    const GENDER = 'boys';
    let players = [];

    // Setup logout
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      if (confirm('Are you sure you want to logout?')) {
        auth.logout('../../index.html');
      }
    });

    // Load players
    async function loadPlayers() {
      if (!currentUser || !currentUser.id) {
        showMessage('Not logged in. Please log in again.', 'error');
        return;
      }

      try {
        const res = await api.get(`/api/players?coachId=${currentUser.id}&gender=${GENDER}`);
        if (!res.ok) {
          const err = await res.json();
          showMessage(err.error || 'Failed to load players', 'error');
          return;
        }

        players = await res.json();
        renderPlayersTable();
      } catch (err) {
        console.error('Failed to load players:', err);
        showMessage('Failed to load players', 'error');
      }
    }

    // Render players table
    function renderPlayersTable() {
      const container = document.getElementById('playersContainer');

      if (players.length === 0) {
        container.innerHTML = '<p class="no-players">No players added yet. Go to the Players page to add players.</p>';
        return;
      }

      const table = document.createElement('table');
      table.innerHTML = `
        <thead>
          <tr>
            <th>Player</th>
            <th>Game 1</th>
            <th>Game 2</th>
            <th>Game 3</th>
            <th>Varsity</th>
          </tr>
        </thead>
        <tbody>
          ${players.map((player, index) => `
            <tr>
              <td>${player.first_name} ${player.last_name}</td>
              <td><input type="number" class="score-input" id="g1_${index}" min="0" max="300" placeholder="0"></td>
              <td><input type="number" class="score-input" id="g2_${index}" min="0" max="300" placeholder="0"></td>
              <td><input type="number" class="score-input" id="g3_${index}" min="0" max="300" placeholder="0"></td>
              <td style="text-align: center;"><input type="checkbox" class="varsity-checkbox" id="varsity_${index}" checked></td>
            </tr>
          `).join('')}
        </tbody>
      `;

      container.innerHTML = '';
      container.appendChild(table);
    }

    // Save match and scores
    async function saveMatch() {
      const matchDate = document.getElementById('matchDate').value;
      const opponent = document.getElementById('opponent').value.trim();
      const location = document.getElementById('location').value.trim();
      const comments = document.getElementById('comments').value.trim();

      if (!matchDate || !opponent) {
        showMessage('Please fill in match date and opponent', 'error');
        return;
      }

      try {
        // Step 1: Create match
        const matchRes = await api.post('/api/matches', {
          coachId: currentUser.id,
          gender: GENDER,
          opponent,
          matchDate,
          location: location || null
        });

        if (!matchRes.ok) {
          const err = await matchRes.json();
          showMessage(err.error || 'Failed to create match', 'error');
          return;
        }

        const match = await matchRes.json();
        console.log('Match created:', match);

        // Step 2: Save scores for each player
        let savedCount = 0;
        for (let i = 0; i < players.length; i++) {
          const g1 = document.getElementById(`g1_${i}`).value;
          const g2 = document.getElementById(`g2_${i}`).value;
          const g3 = document.getElementById(`g3_${i}`).value;
          const varsity = document.getElementById(`varsity_${i}`).checked;

          // Only save if at least one score is entered
          if (g1 || g2 || g3) {
            const recordRes = await api.post('/api/records', {
              matchId: match.id,
              playerId: players[i].id,
              game1: g1 ? parseInt(g1) : null,
              game2: g2 ? parseInt(g2) : null,
              game3: g3 ? parseInt(g3) : null
            });

            if (recordRes.ok) {
              savedCount++;
            }
          }
        }

        // Success!
        showMessage(`Match saved successfully! ${savedCount} player records saved.`, 'success');
        
        // Clear form after 2 seconds
        setTimeout(() => {
          document.getElementById('matchDate').value = '';
          document.getElementById('opponent').value = '';
          document.getElementById('location').value = '';
          document.getElementById('comments').value = '';
          
          // Clear all score inputs
          players.forEach((_, i) => {
            document.getElementById(`g1_${i}`).value = '';
            document.getElementById(`g2_${i}`).value = '';
            document.getElementById(`g3_${i}`).value = '';
            document.getElementById(`varsity_${i}`).checked = true;
          });

          document.getElementById('message').className = 'message';
        }, 2000);

      } catch (err) {
        console.error('Failed to save match:', err);
        showMessage('Failed to save match. Please try again.', 'error');
      }
    }

    // Show message
    function showMessage(text, type) {
      const msg = document.getElementById('message');
      msg.textContent = text;
      msg.className = `message ${type}`;
      setTimeout(() => { msg.className = 'message'; }, 5000);
    }

    // Event listeners
    document.getElementById('submitBtn').addEventListener('click', saveMatch);

    // Load players on page load
    loadPlayers();
  </script>
</body>
</html>
